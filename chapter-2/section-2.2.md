# 리액트 핵심 요소 깊게 살펴보기

## 2.2 가상 DOM과 리액트 파이버

리액트의 대표적인 특징 중 하나가 가상 DOM 방식의 운영이다. 가상 DOM이 무엇인지, 실제 DOM에 비해 어떤 이점이 있는지 살펴보자.

### 2.2.1 DOM과 브라우저 렌더링 과정

DOM(Document Object Model)이란 웹페이지에 대한 인터페이스로써 브라우저가 웹페이지의 콘텐츠와 구조를 어떻게 보여줄지에 대한 정보를 담고 있다. 아래는 브러우저가 웹사이트 접근 요청을 받고 화면을 그리는 과정이다.

1. 사용자가 요청한 주소를 방문해 HTML 파일을 다운로드한다.
2. 브라우저의 렌더링 엔진은 HTML을 파싱해 노드로 구성된 트리(DOM)를 만든다.
3. 2번 과정에서 CSS를 만나면 해당 CSS 파일도 다운로드한다.
4. CSS도 파싱해 CSS 노드로 구성된 트리(`CSSO`M)을 만든다.
5. 2번에서 만든 DOM 노드를 순회하는데, 모든 노드가 아닌 사용자 눈에 보이는 노드만 방문한다. 즉, `display: none`과 같은 화면에 보이지 않는 요소는 작업하지 않는다. (트리 분석 과정을 조금이라도 빠르게 하기 위함)
6. 5번에 해당되는 노드를 대상으로 해당 노드의 `CSSOM` 정보를 찾고 여기서 발견한 CSS 스타일 정보를 노드에 적용한다.
   - `레이아웃(layout, reflow)`: 각 노드가 브라우저 화면 어느 좌표에 정확히 나타나야 하는지 계산하는 과정.
   - `페인팅(painting)`: 레이아웃 단계를 거친 노드에 색과 같은 실제 유효한 모습을 그리는 과정.

### 2.2.2 가상 DOM의 탄생 배경

결과적으로 개발자는 사용자의 인터랙션에 DOM의 변경사항 보다는, 그 결과물 하나만 알고싶을 것이다. DOM의 최종 결과물을 간편하게 제공하기 위해 탄생한 것이 가상 DOM이다. 가상 DOM에서 변경 및 변경 완료를 마치면 실제 DOM에 반영한다.

### 2.2.3 가상 DOM을 위한 아키텍처, 리액트 파이버

리액트의 여러 번의 렌더링 과정을 압축해 최소한의 렌더링 단위를 만들어 내는 것을 가능하게 하는 것이 `리액트 파이버(React Fiber)`이다.

#### 📌 리액트 파이버란?

리액트에서 관리하는 평범한 자바스크립트 객체다. 파이버는 `파이버 재조정자(fiber reconciler)`가 관리하는데, 가상 DOM과 실제 DOM을 비교해 변경 사항을 수집하고 차이가 있으면 변경에 관련된 정보를 가지고 있는 파이버를 기준으로 화면에 렌더링을 요청하는 역할을 한다.

쉽게 말해, `파이버 재조정`이란 리액트에서 어떤 부분을 새롭게 렌더링 해야하는지 `가상 DOM과 실제 DOM을 비교하는 작업(알고리즘)`이라 이해하면 된다.

리액트 파이버의 목표는 웹에서 발생하는 애니메이션, 레이아웃, 사용자 인터랙션에 올바른 결과물을 만드는 반응성 문제를 해결하는 것이다.

- 작업을 작은 단위로 쪼갠 다음, 우선순위를 매긴다.
- 이러한 작업을 일시 중지하고 나중에 다시 시작할 수 있다.
- 이전에 했던 작업을 다시 재사용하거나 필요하지 않은 경우에는 폐기할 수 있다.

중요한 점은 이 모든 과정이 비동기로 일어난다는 것이다.

파이버는 하나의 작업 단위로 구성되어 있고, `finisheWork()`라는 작업으로 단위를 처리하는데, 이 작업을 커밋해 실제 DOM에 변경 사항을 만들어 낸다.

1. 렌더 단계에서 사용자에게 노출되지 않는 모든 비동기 작업을 수행한다.
2. 커밋 단계에서 실제 DOM의 변경 사항을 반영하기 위한 작업을 진행한다. 이 과정은 동기식으로 일어나며, 중단될 수 없다.

파이버는 하나의 element에 하나가 생성되는 1:1 관계를 가지고 있다. 여기서 매칭된 정보를 가지고 있는게 tag다.

실제로 리액트 개발 팀은 리액트가 가상 DOM이 아닌 Value UI, 즉 값을 가지고 있는 UI를 관리하는 라이브러리라는 내용을 피력한 바 있다. 변수에 이러한 UI에 대한 값을 문자열, 숫자, 배열과 같은 값으로 보관하고 이를 관리, 표현하는 것이 리액트다.

#### 📌 리액트 파이버 트리

파이버 트리는 리액트 내부에서 두 개가 존재한다. 하나는 현재 모습을 담은 트리이고, 다른 하나는 작업 중인 상태를 나타내는 `workInProgress` 트리다. 파이버의 작업이 끝나면 리액트는 단순히 포인터만 변경해 `workInProgress` 트리를 현재 트리로 바꿔버린다. 이러한 기술을 `더블 버퍼링`이라고 한다. (`더블 버퍼링`은 가상 DOM 방식처럼, 변경 결과만을 보여주는 기법이다.)

#### 📌 파이버의 작업 순서

일반적인 파이버 노드의 생성 흐름은 다음과 같다.

1. 리액트는 `beginWork()` 함수를 실행해 파이버 작업을 수행하는데, 더 이상 자식이 없는 파이버를 만날 때까지 트리 형식으로 시작된다.
2. 그 다음 `completeWork()` 함수를 실행해 파이버 작업을 완료한다.
3. 형제가 있다면 형제로 넘어간다.
4. return으로 돌아가 자신의 작업이 완료되었음을 알린다.

`setState` 등으로 업데이트가 발생하면, 요청을 받아 `workInProgress` 트리를 다시 빌드하기 시작한다. 최초 렌더링 시에는 모든 파이버를 새롭게 만들어야 하지만, 업데이트 때는 이미 존재하므로 새로 생성하지 않고 재사용한다.

이 과정들을 과거에는 동기식으로 처리했고, 중단될 수 없었다. 하지만 현재는 우선순위에 따라 현재 진행중인 업데이트 작업을 일시 중단하거나 새롭게 만들거나, 폐기할 수도 있다. 애니메이션이나 사용자가 입력하는 작업은 우선순위가 높은 작업으로 분리하거나, 목록을 렌더링 하는 등의 작업은 우선순위가 낮은 작업을 분리해 최적의 순위로 작업을 완료할 수 있게 한다.

### 2.2.4 파이버와 가상 DOM

파이버의 작동 방식과 알고리즘을 이해했다면 가상 DOM에 대해서도 이해하기 쉬워질 것이다.

파이버는 리액트 아키텍처 내부에서 비동기로 이뤄진다. 결과물만 실제 DOM에 적용하는 것이다. 본문에서는 가상 DOM이라는 표현을 썼지만 엄밀히 말하자면 이는 웹 서비스에서만 통용되는 개념이다. 사실상 파이버와 가상 DOM은 동일한 개념이 아니다.
